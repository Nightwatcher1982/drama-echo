<!--æ¼”å‘˜è¯¦æƒ…é¡µé¢-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <view wx:else>
    <!-- é¡¶éƒ¨å¤´éƒ¨ -->
    <view class="header">
      <view class="header-title">æˆå‰§å›å“</view>
      <view class="header-subtitle">ä¸“å±æˆå‰§æ¼”å‘˜è¯­éŸ³æ”¶è—</view>
    </view>

    <!-- æ¼”å‘˜ä¿¡æ¯å¡ç‰‡ -->
    <view class="actor-card">
      <view class="actor-info">
        <view class="actor-avatar">{{actor.avatar}}</view>
        <view class="actor-details">
          <text class="actor-name">{{actor.name}}</text>
          <text class="actor-title">{{actor.title}}</text>
          <text class="actor-desc">{{actor.description}}</text>
          <view class="voice-count">{{actor.stats.voicePackCount}}ä¸ªè¯­éŸ³åŒ…</view>
        </view>
      </view>
    </view>

    <!-- ç«äº‰çŠ¶æ€ -->
    <view class="competition-status">
      <view class="competition-text">ğŸ­ æœ¬æœˆå·²æœ‰ {{actor.stats.guardianCount}} ä½ç²‰ä¸åŠ å…¥æ”¶è—ï¼Œè°å°†æˆä¸ºä¸‹ä¸€ä¸ªå®ˆæŠ¤è€…ï¼Ÿ</view>
    </view>

    <!-- ç²‰ä¸æ’è¡Œæ¦œ -->
    <view class="ranking-section">
      <view class="section-header">
        <view class="section-title">ç²‰ä¸æ”¯æŒæ¦œ</view>
        <view class="view-all" bind:tap="viewFullRanking">æŸ¥çœ‹å®Œæ•´æ¦œå• â†’</view>
      </view>
      <view class="ranking-list">
        <view wx:for="{{fanRanking}}" wx:key="_id" class="ranking-item">
          <view class="rank-number rank-{{index < 3 ? index + 1 : 'other'}}">{{index + 1}}</view>
          <view class="fan-info">
            <view class="fan-name">{{item.userInfo.nickName}}</view>
            <view class="purchase-count">å·²æ”¶è— {{item.purchaseCount}} ä¸ªä¸“å±å£°éŸ³</view>
          </view>
          <view class="support-level">
            <view class="star-level">
              <text wx:for="{{item.starCount}}" wx:for-item="star" wx:key="*this">â­</text>
            </view>
            <view class="level-text">{{item.level}}</view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view wx:if="{{fanRanking.length === 0}}" class="empty-ranking">
          <view class="empty-icon">ğŸ‘‘</view>
          <view class="empty-text">æš‚æ— æ”¯æŒæ¦œï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå®ˆæŠ¤è€…å§ï¼</view>
        </view>
      </view>
    </view>

    <!-- è¯­éŸ³åŒ…å±•ç¤º -->
    <view class="voice-packs">
      <view class="section-header">
        <view class="section-title">ğŸ­ ç²¾é€‰è¯­éŸ³åŒ…</view>
      </view>
      <view class="packs-grid">
        <view wx:for="{{voicePacks}}" wx:key="_id" 
              class="pack-item {{item.isPurchased ? 'purchased' : ''}} {{item.isSelected ? 'selected' : ''}}"
              data-pack-id="{{item._id}}"
              data-price="{{item.price}}"
              data-is-purchased="{{item.isPurchased}}"
              bind:tap="togglePackSelection"
              bind:longpress="goToPackDetail">
          
          <!-- çƒ­é—¨æ ‡ç­¾ -->
          <view wx:if="{{item.isHot && !item.isPurchased}}" class="hot-badge">HOT</view>
          
          <!-- å·²è´­ä¹°æ ‡ç­¾ -->
          <view wx:if="{{item.isPurchased}}" class="purchased-badge">å·²æ‹¥æœ‰</view>
          
          <!-- é€‰ä¸­æ ‡è®° -->
          <view wx:if="{{item.isSelected}}" class="selected-mark">âœ“</view>
          
          <view class="pack-icon">{{item.icon}}</view>
          <view class="pack-name">{{item.name}}</view>
          <view class="pack-price">Â¥{{item.formattedPrice}}</view>
          <view class="pack-sales">å·²å”® {{item.sales}} ä»½</view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="pack-buttons">
            <view class="buy-button"
                  data-pack-id="{{item._id}}"
                  data-is-purchased="{{item.isPurchased}}"
                  catch:tap="{{item.isPurchased ? 'goToPackDetail' : 'showPackDetail'}}">
              {{item.isPurchased ? 'â–¶ï¸ æ’­æ”¾' : 'ğŸ’° è´­ä¹°'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œåŒºåŸŸ -->
    <view class="bottom-spacing"></view>
  </view>

  <!-- è¯­éŸ³åŒ…è¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showPackDetailModal}}" class="modal-overlay" bind:tap="closePackDetail">
    <view class="modal-content" catch:tap="">
      <view class="modal-header">
        <view class="modal-title">{{currentPackDetail.name}}</view>
        <view class="modal-close" bind:tap="closePackDetail">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- å¥—é¤å†…å®¹ -->
        <view class="package-info-section">
          <view class="package-title">
            <text class="title-icon">ğŸ</text>
            <text class="title-text">å¥—é¤å†…å®¹</text>
          </view>
          
          <view class="package-includes">
            <view class="include-item">
              <text class="item-icon">ğŸµ</text>
              <text class="item-text">å…¨éƒ¨{{currentPackDetail.voiceCount || 0}}æ¡è¯­éŸ³</text>
            </view>
            <view class="include-item" wx:if="{{currentPackDetail.images && currentPackDetail.images.length > 0}}">
              <text class="item-icon">ğŸ“¸</text>
              <text class="item-text">é«˜æ¸…å†™çœŸå›¾åŒ… ({{currentPackDetail.images.length}}å¼ )</text>
            </view>
            <view class="include-item" wx:if="{{currentPackDetail.bonusVideoUrl}}">
              <text class="item-icon">ğŸ¬</text>
              <text class="item-text">ç‹¬å®¶èŠ±çµ®è§†é¢‘</text>
            </view>
          </view>
        </view>
        
        <!-- ä»·æ ¼ä¿¡æ¯ -->
        <view class="price-info-section">
          <view class="price-item">
            <text class="price-label">å¥—é¤ä»·æ ¼ï¼š</text>
            <text class="price-value">Â¥{{(currentPackDetail.packagePrice || 0) / 100}}</text>
          </view>
          <view class="price-item" wx:if="{{currentPackDetail.originalPrice && currentPackDetail.originalPrice > currentPackDetail.packagePrice}}">
            <text class="price-label">åŸä»·ï¼š</text>
            <text class="original-price">Â¥{{(currentPackDetail.originalPrice || 0) / 100}}</text>
          </view>
          <view class="save-info" wx:if="{{currentPackDetail.saveAmount && currentPackDetail.saveAmount > 0}}">
            <text class="save-text">èŠ‚çœ Â¥{{(currentPackDetail.saveAmount || 0) / 100}}</text>
          </view>
        </view>
        
        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <view class="detail-info-section">
          <view class="pack-info-item">
            <text class="info-label">æ€»æ—¶é•¿ï¼š</text>
            <text class="info-value">{{currentPackDetail.totalDuration || 'æœªçŸ¥'}}</text>
          </view>
          
          <view class="pack-info-item">
            <text class="info-label">åˆ†ç±»ï¼š</text>
            <text class="info-value">{{currentPackDetail.category || 'æœªåˆ†ç±»'}}</text>
          </view>
          
          <view class="pack-info-item" wx:if="{{currentPackDetail.description}}">
            <text class="info-label">æè¿°ï¼š</text>
            <text class="info-value">{{currentPackDetail.description}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-buy-btn" bind:tap="goToPackDetailFromModal">
          {{currentPackDetail.isPurchased ? 'è¿›å…¥è¯¦æƒ…é¡µ' : 'ç«‹å³è´­ä¹°'}}
        </button>
      </view>
    </view>
  </view>

  <!-- è¯­éŸ³æ’­æ”¾å™¨ç»„ä»¶ -->
  <voice-player 
    isOpen="{{showVoicePlayer}}"
    currentPack="{{currentVoicePack}}"
    currentActor="{{actor}}"
    playlist="{{voicePlaylist}}"
    bind:close="closeVoicePlayer">
  </voice-player>
</view>