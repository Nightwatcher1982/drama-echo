<!-- 语音包管理后台 -->
<view class="container">
  <view class="header">
    <view class="header-title">🎵 语音包管理后台</view>
    <view class="header-subtitle">演员语音内容上传与管理</view>
  </view>

  <!-- 身份验证 -->
  <view class="auth-section glass-card" wx:if="{{!isAuthenticated}}">
    <view class="auth-title">管理员身份验证</view>
    <input class="auth-input" type="password" placeholder="请输入管理密码" value="{{adminPassword}}" bindinput="onPasswordInput" />
    <button class="btn-primary" bindtap="authenticate">验证身份</button>
  </view>

  <!-- 管理面板 -->
  <view class="admin-panel" wx:if="{{isAuthenticated}}">
    
    <!-- 演员选择 -->
    <view class="section glass-card">
      <view class="section-header">
        <view class="section-title">🎭 选择演员</view>
        <button class="btn-outline btn-small" wx:if="{{selectedActorId}}" bindtap="showEditActorModal">编辑演员</button>
      </view>
      <view class="actors-selector">
        <view wx:for="{{actors}}" wx:key="_id" 
              class="actor-item {{selectedActorId === item._id ? 'selected' : ''}}"
              bindtap="selectActor" data-actor-id="{{item._id}}">
          <view class="actor-avatar">{{item.avatar}}</view>
          <view class="actor-info">
            <view class="actor-name">{{item.name}}</view>
            <view class="actor-title">{{item.title}}</view>
            <view class="pack-count">{{item.stats.voicePackCount}}个语音包</view>
          </view>
          <view class="status-indicator {{item.status}}"></view>
        </view>
      </view>
    </view>

    <!-- 语音包管理 -->
    <view class="section glass-card" wx:if="{{selectedActorId}}">
      <view class="section-header">
        <view class="section-title">🎵 {{selectedActorName}} - 语音包管理</view>
        <button class="btn-primary" bindtap="showAddPackModal">+ 创建新语音包</button>
      </view>

      <!-- 语音包列表 -->
      <view class="voice-packs-list">
        <view wx:for="{{voicePacks}}" wx:key="_id" class="pack-card">
          <view class="pack-header">
            <view class="pack-basic-info">
              <view class="pack-icon">{{item.icon}}</view>
              <view class="pack-details">
                <view class="pack-name">{{item.name}}</view>
                <view class="pack-price">
                  <text class="price-number">{{item.priceValue}}</text>
                  <text class="price-unit">个回响</text>
                </view>
                <view class="pack-meta">
                  已售: {{item.sales}} 份 | 文件: {{item.voiceFiles.length}}个
                  <text wx:if="{{item.isHot}}" class="hot-tag">🔥热门</text>
                </view>
              </view>
            </view>
            <view class="pack-actions">
              <button class="btn-outline btn-small" bindtap="editPack" data-pack="{{item}}">编辑</button>
              <button class="btn-secondary btn-small" bindtap="manageVoiceFiles" data-pack-id="{{item._id}}">管理音频</button>
            </view>
          </view>

          <!-- 语音文件列表 -->
          <view class="voice-files-section" wx:if="{{item.showFiles}}">
            <view class="files-header">
              <text class="files-title">语音文件 ({{item.voiceFiles.length}})</text>
              <button class="btn-small btn-primary" bindtap="showAddFileModal" data-pack-id="{{item._id}}">+ 添加音频</button>
            </view>
            <view class="voice-files-list">
              <view wx:for="{{item.voiceFiles}}" wx:for-item="file" wx:key="*this" class="voice-file-item">
                <view class="file-info">
                  <view class="file-icon">🎵</view>
                  <view class="file-details">
                    <view class="file-name">{{file.name}}</view>
                    <view class="file-meta">
                      <text class="meta-item">时长: {{file.duration || 30}}s</text>
                      <text class="meta-item" wx:if="{{file.size}}">大小: {{file.size}}B</text>
                    </view>
                    <view class="file-description" wx:if="{{file.description}}">{{file.description}}</view>
                    <view class="file-path">{{file.fileId}}</view>
                  </view>
                </view>
                <view class="file-actions">
                  <button class="btn-outline btn-small" bindtap="playVoiceFile" data-file="{{file}}">播放</button>
                  <button class="btn-outline btn-small" bindtap="editVoiceFile" data-file="{{file}}" data-pack-id="{{item._id}}">编辑</button>
                  <button class="btn-danger btn-small" bindtap="deleteVoiceFile" data-file-id="{{file.id}}" data-pack-id="{{item._id}}">删除</button>
                </view>
              </view>
              
              <view wx:if="{{item.voiceFiles.length === 0}}" class="empty-files">
                <text class="empty-text">暂无语音文件</text>
              </view>
            </view>
          </view>
        </view>

        <view wx:if="{{voicePacks.length === 0}}" class="empty-packs">
          <view class="empty-icon">🎵</view>
          <view class="empty-text">该演员暂无语音包</view>
          <button class="btn-primary" bindtap="showAddPackModal">创建第一个语音包</button>
        </view>
      </view>
    </view>

    <!-- 统计信息 -->
    <view class="stats-section glass-card" wx:if="{{selectedActorId}}">
      <view class="section-title">📊 统计信息</view>
      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-number">{{stats.totalPacks}}</view>
          <view class="stat-label">语音包总数</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{stats.totalFiles}}</view>
          <view class="stat-label">音频文件总数</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{stats.totalSales}}</view>
          <view class="stat-label">总销量</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{stats.totalRevenue}}</view>
          <view class="stat-label">总收入(元)</view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 语音包编辑弹窗 -->
<view class="modal-overlay {{showPackModal ? 'show' : ''}}" bindtap="hidePackModal">
  <view class="modal" bindtap="stopPropagation">
    <view class="modal-header">
      <view class="modal-title">{{editingPack._id ? '编辑语音包' : '创建语音包'}}</view>
      <view class="modal-close" bindtap="hidePackModal">×</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y="true">
      <view class="form-group">
        <label class="form-label">语音包名称</label>
        <input class="form-input" value="{{editingPack.name}}" 
               bindinput="onPackInput" data-field="name" placeholder="如：经典台词集" />
      </view>
      
      <view class="form-group">
        <label class="form-label">图标 Emoji</label>
        <input class="form-input emoji-input" value="{{editingPack.icon}}" 
               bindinput="onPackInput" data-field="icon" placeholder="🌹" />
      </view>
      
      <view class="form-group">
        <label class="form-label">价格（元）</label>
        <input class="form-input" type="digit" value="{{editingPack.displayPrice}}" 
               bindinput="onPackPriceInput" placeholder="68.00" />
      </view>
      
      <view class="form-group">
        <label class="form-label">语音包描述</label>
        <textarea class="form-textarea" value="{{editingPack.description}}" 
                  bindinput="onPackInput" data-field="description" 
                  placeholder="语音包简介..." maxlength="200"></textarea>
      </view>
      
      <view class="form-group">
        <label class="form-label">语音包图片</label>
        <view class="images-upload-section">
          <view class="images-list">
            <view wx:for="{{editingPack.images}}" wx:key="index" class="image-item">
              <image class="uploaded-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-index="{{index}}"></image>
              <button class="btn-small btn-danger remove-image" bindtap="removePackImage" data-index="{{index}}">×</button>
            </view>
            <view wx:if="{{editingPack.images.length < 5}}" class="add-image-btn" bindtap="choosePackImage">
              <view class="add-icon">📷</view>
              <view class="add-text">添加图片</view>
            </view>
          </view>
          <view class="upload-hint">最多可上传5张图片，支持JPG、PNG格式</view>
        </view>
      </view>
      
      <view class="form-group">
        <label class="form-label">花絮视频</label>
        <view class="video-upload-section">
          <view wx:if="{{!editingPack.bonusVideoUrl}}" class="video-upload-area" bindtap="chooseBonusVideo">
            <view class="upload-placeholder">
              <view class="upload-icon">🎬</view>
              <view class="upload-text">点击上传花絮视频</view>
              <view class="upload-hint">支持MP4格式，建议时长不超过5分钟</view>
            </view>
          </view>
          <view wx:else class="video-preview">
            <video class="preview-video" src="{{editingPack.bonusVideoUrl}}" controls="{{true}}" poster="{{editingPack.bonusVideoThumb}}"></video>
            <view class="video-actions">
              <button class="btn-small btn-primary" bindtap="chooseVideoCover">上传封面</button>
              <button class="btn-small btn-outline" bindtap="chooseBonusVideo">重新上传</button>
              <button class="btn-small btn-danger" bindtap="removeBonusVideo">删除</button>
            </view>
            <view class="video-info">
              <view class="video-title">{{editingPack.bonusVideoTitle || '花絮视频'}}</view>
              <view class="video-duration">{{editingPack.bonusVideoDuration || '未知时长'}}</view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="form-group">
        <label class="form-label">设置选项</label>
        <view class="checkbox-group">
          <label class="checkbox-item">
            <checkbox checked="{{editingPack.isHot}}" bindchange="onPackHotChange" />
            标记为热门
          </label>
          <label class="checkbox-item">
            <checkbox checked="{{editingPack.isActive}}" bindchange="onPackActiveChange" />
            启用销售
          </label>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <button class="btn-outline" bindtap="hidePackModal">取消</button>
      <button class="btn-primary" bindtap="savePack">保存</button>
    </view>
  </view>
</view>

<!-- 演员编辑弹窗 -->
<view class="modal-overlay {{showActorModal ? 'show' : ''}}" bindtap="hideActorModal">
  <view class="modal" bindtap="stopPropagation">
    <view class="modal-header">
      <view class="modal-title">编辑演员</view>
      <view class="modal-close" bindtap="hideActorModal">×</view>
    </view>

    <scroll-view class="modal-body" scroll-y="true">
      <view class="form-group">
        <label class="form-label">演员名称</label>
        <input class="form-input" value="{{editingActor.name}}" bindinput="onActorInput" data-field="name" placeholder="请输入演员名称" />
      </view>
      <view class="form-group">
        <label class="form-label">演员称号</label>
        <input class="form-input" value="{{editingActor.title}}" bindinput="onActorInput" data-field="title" placeholder="如：古典戏剧表演艺术家" />
      </view>
      <view class="form-group">
        <label class="form-label">演员简介</label>
        <textarea class="form-textarea" value="{{editingActor.description}}" bindinput="onActorInput" data-field="description" placeholder="请输入简介" maxlength="200"></textarea>
      </view>
      <view class="form-group">
        <label class="form-label">演员图片</label>
        <view class="file-upload-area" bindtap="chooseActorImage">
          <view wx:if="{{!tempImagePath && !editingActor.imageUrl}}" class="upload-placeholder">
            <view class="upload-icon">📷</view>
            <view class="upload-text">点击选择图片</view>
          </view>
          <view wx:else class="image-preview">
            <image class="image" src="{{tempImagePath || editingActor.imageUrl}}" mode="aspectFill"></image>
            <button class="btn-small btn-outline" bindtap="chooseActorImage">重新选择</button>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="modal-footer">
      <button class="btn-outline" bindtap="hideActorModal">取消</button>
      <button class="btn-primary" bindtap="saveActor">保存</button>
    </view>
  </view>
</view>

<!-- 语音文件编辑弹窗 -->
<view class="modal-overlay {{showFileModal ? 'show' : ''}}" bindtap="hideFileModal">
  <view class="modal" bindtap="stopPropagation">
    <view class="modal-header">
      <view class="modal-title">{{editingFile.id ? '编辑语音文件' : '添加语音文件'}}</view>
      <view class="modal-close" bindtap="hideFileModal">×</view>
    </view>
    
    <scroll-view class="modal-body" scroll-y="true">
      <view class="form-group">
        <label class="form-label">文件名称</label>
        <input class="form-input" value="{{editingFile.name}}" 
               bindinput="onFileInput" data-field="name" placeholder="如：温柔晚安" />
      </view>
      
      <view class="form-group">
        <label class="form-label">语音文件</label>
        <view class="file-upload-area" bindtap="chooseVoiceFile">
          <view wx:if="{{!editingFile.tempFilePath}}" class="upload-placeholder">
            <view class="upload-icon">📁</view>
            <view class="upload-text">点击选择音频文件</view>
            <view class="upload-hint">支持 MP3、WAV、AAC 格式</view>
          </view>
          <view wx:else class="uploaded-file">
            <view class="file-icon">🎵</view>
            <view class="file-name">{{editingFile.fileName}}</view>
            <button class="btn-small btn-outline" bindtap="removeVoiceFile">重新选择</button>
          </view>
        </view>
      </view>
      
      <view class="form-group">
        <label class="form-label">时长（秒）</label>
        <input class="form-input" type="number" value="{{editingFile.duration}}" 
               bindinput="onFileInput" data-field="duration" placeholder="30" />
      </view>
      
      <view class="form-group">
        <label class="form-label">文件描述</label>
        <textarea class="form-textarea" value="{{editingFile.description}}" 
                  bindinput="onFileInput" data-field="description" 
                  placeholder="语音内容描述..." maxlength="100"></textarea>
      </view>

      <view class="form-group" wx:if="{{editingFile.tempFilePath}}">
        <label class="form-label">预览</label>
        <view class="audio-preview">
          <button class="btn-outline" bindtap="previewAudio">🎵 播放预览</button>
        </view>
      </view>
    </scroll-view>
    
    <view class="modal-footer">
      <button class="btn-outline" bindtap="hideFileModal">取消</button>
      <button class="btn-primary" bindtap="saveVoiceFile" disabled="{{uploading}}">
        {{uploading ? '上传中...' : '保存'}}
      </button>
    </view>
  </view>
</view>

<!-- 音频播放器组件 -->
<audio-player 
  show="{{showAudioPlayer}}"
  audioUrl="{{currentAudioUrl}}"
  fileName="{{currentAudioFileName}}"
  coverImage="{{editingPack && editingPack.images && editingPack.images[0] ? editingPack.images[0] : ''}}"
  bind:close="closeAudioPlayer">
</audio-player>