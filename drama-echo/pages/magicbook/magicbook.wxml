<!--魔法之书页面-->
<view class="container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="title">📖 魔法之书</view>
    <view class="subtitle">星座运势指引，记录当下心情</view>
  </view>

  <!-- 星座运势内容 -->
  <view class="content-section">
    <!-- 我的星座快捷入口 -->
    <view wx:if="{{showMyZodiac}}" class="my-zodiac-section">
      <view class="section-title">我的星座</view>
      <view class="my-zodiac-card">
        <view class="zodiac-info">
          <text class="zodiac-symbol">{{userZodiac.symbol}}</text>
          <view class="zodiac-details">
            <text class="zodiac-name">{{userZodiac.name}}</text>
            <text class="zodiac-dates">{{userZodiac.dates}}</text>
          </view>
        </view>
      </view>
      <view class="change-zodiac" bindtap="changeZodiac">
        <text>更换星座</text>
      </view>
    </view>

    <!-- 当下心情触发魔法部分（紧凑版） -->
    <view class="mood-section-compact">
      <view class="mood-description-compact">
        <text>选择心情，触发魔法</text>
      </view>
      
      <!-- 紧凑心情选择 -->
      <view class="mood-grid-compact">
        <view wx:for="{{simpleMoods}}" wx:key="name" 
              class="mood-item-compact {{item.selected ? 'selected' : ''}}" 
              bindtap="selectMood" 
              data-mood="{{item}}">
          <view class="mood-emoji-compact">{{item.emoji}}</view>
          <view class="mood-name-compact">{{item.name}}</view>
        </view>
      </view>
    </view>

    <!-- 发动魔法按钮 -->
    <view class="magic-button-section">
      <view class="magic-button-container">
        <!-- 外圈燃烧进度条 -->
        <view class="magic-progress-outer">
          <svg class="progress-svg-outer" width="360" height="360">
            <!-- 外圈底色 -->
            <circle 
              class="progress-bg-outer" 
              cx="180" 
              cy="180" 
              r="162" 
              fill="none" 
              stroke="rgba(106, 90, 205, 0.2)" 
              stroke-width="6"/>
            <!-- 进度条 -->
            <circle 
              wx:if="{{isCastingMagic}}"
              class="progress-fill-outer" 
              cx="180" 
              cy="180" 
              r="162" 
              fill="none" 
              stroke="url(#magicGradient)" 
              stroke-width="6"
              stroke-linecap="round"
              style="stroke-dasharray: {{2 * 3.14159 * 162}}; stroke-dashoffset: {{2 * 3.14159 * 162 * (100 - castingProgress) / 100}};"
              transform="rotate(-90 180 180)"/>
            <defs>
              <linearGradient id="magicGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#9B59B6"/>
                <stop offset="33%" stop-color="#8E44AD"/>
                <stop offset="66%" stop-color="#6A5ACD"/>
                <stop offset="100%" stop-color="#4B0082"/>
              </linearGradient>
            </defs>
          </svg>
          
          <!-- 魔法粒子围绕效果 -->
          <view wx:if="{{isCastingMagic}}" class="magic-particles-orbit">
            <view class="magic-particle magic-particle-1">✨</view>
            <view class="magic-particle magic-particle-2">⭐</view>
            <view class="magic-particle magic-particle-3">💫</view>
            <view class="magic-particle magic-particle-4">🌟</view>
          </view>
        </view>
        
        <!-- 主魔法按钮 -->
        <button 
          class="magic-button-main {{isCastingMagic ? 'casting' : ''}}" 
          bindtouchstart="startCastMagic"
          bindtouchend="stopCastMagic"
          bindtouchcancel="stopCastMagic">
          
          <!-- 未施法状态 -->
          <view wx:if="{{!isCastingMagic}}" class="magic-button-idle">
            <view class="magic-wand-idle">🪄</view>
            <view class="magic-text-main">长按发动</view>
          </view>
          
          <!-- 施法状态 -->
          <view wx:if="{{isCastingMagic}}" class="magic-button-casting">
            <view class="magic-crystal-casting">🔮</view>
            <view class="magic-text-casting">施法中...</view>
          </view>
        </button>
      </view>
    </view>
    
    <!-- 全屏魔法特效 -->
    <view wx:if="{{showMagicEffect}}" class="magic-effect-overlay">
      <view class="magic-sparkles">
        <view class="sparkle sparkle-1">✨</view>
        <view class="sparkle sparkle-2">⭐</view>
        <view class="sparkle sparkle-3">💫</view>
        <view class="sparkle sparkle-4">🌟</view>
        <view class="sparkle sparkle-5">✨</view>
        <view class="sparkle sparkle-6">⭐</view>
        <view class="sparkle sparkle-7">💫</view>
        <view class="sparkle sparkle-8">🌟</view>
      </view>
      <view class="magic-flash"></view>
    </view>
  </view>

  <!-- 最近记录 -->
  <view wx:if="{{recentRecords.length > 0}}" class="recent-section">
    <view class="section-title">最近的魔法时刻</view>
    <view class="recent-list">
      <view wx:for="{{recentRecords}}" wx:key="id" class="recent-item">
        <view class="record-type">
          <text wx:if="{{item.type === 'zodiac'}}">⭐</text>
          <text wx:if="{{item.type === 'mood'}}">💭</text>
        </view>
        <view class="record-content">
          <view class="record-title">{{item.title}}</view>
          <view class="record-subtitle">{{item.subtitle}}</view>
        </view>
        <view class="record-date">{{item.date}}</view>
      </view>
    </view>
  </view>

  <!-- 使用完毕提示 -->
  <view wx:if="{{!canUseToday}}" class="limit-notice">
    <view class="notice-icon">✨</view>
    <view class="notice-text">今日魔法次数已用完</view>
    <view class="notice-subtitle">明天再来探索戏剧的魅力吧～</view>
  </view>
</view>